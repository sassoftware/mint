PythonDebug Off
RewriteEngine on

Include conf.d/conary-web-common.conf
Include conf.d/rbuilder/*.conf

## http -> https IFF not already redirected
# root -> /ui/
RewriteCond     %{HTTPS} !=on
RewriteCond     %{HTTP_COOKIE} !^.*ssl-redirect-done=.*$
RewriteRule     ^/$             https://%{SERVER_NAME}/ui/ [R=302,L]
# /ui -> /ui/
RewriteCond     %{HTTPS} !=on
RewriteCond     %{HTTP_COOKIE} !^.*ssl-redirect-done=.*$
RewriteRule     ^/(ui.*)$       https://%{SERVER_NAME}/$1 [R=302,L]

## https -> http and set cookie to avoid a loop with the above rule
# root -> /ui/
RewriteCond     %{HTTPS} =on
RewriteRule     ^/$             http://%{SERVER_NAME}/ui/ [R=302,L,CO=ssl-redirect-done:yes:%{SERVER_NAME}]
# /ui -> /ui/
RewriteCond     %{HTTPS} =on
RewriteRule     ^/(ui.*)$       http://%{SERVER_NAME}/$1 [R=302,L,CO=ssl-redirect-done:yes:%{SERVER_NAME}]

# Serve different versions of the Conary Configuration based on the
# client's X-Conary-Config-Version header.
RewriteCond     %{HTTP:X-Conary-Config-Version} ^([0-9]+)$
RewriteRule     ^/+conaryrc$    /srv/rbuilder/config/conaryrc.generated-v%{HTTP:X-Conary-Config-Version} [L]

# Redirect setup to rPPA now (RBL-2032)
RewriteCond     %{REQUEST_URI}  ^/setup.*
RewriteRule     ^.*$    https://%{HTTP_HOST}:8003/rbasetup/rBASetup [R=301,L]

# Force browsers to ask about cached files
SetEnvIf Request_URI \.(?:gif|jpe?g|png|swf|swz|html|js|css)$ must-revalidate
Header append Cache-Control must-revalidate env=must-revalidate
# FF will not request swfs again unless we set max-age
Header append Cache-Control max-age=0

# Serve version #0 of the conaryrc for those who aren't gifted with the 
# appropriate header.
Alias /conaryrc         "/srv/rbuilder/config/conaryrc.generated"

Alias /cgi-bin/         "/srv/www/cgi-bin/"
Alias /images/          "/srv/rbuilder/finished-images/"
Alias /xmlrpc/          "/srv/rbuilder/config/rbuilder.conf/"
Alias /xmlrpc-private/  "/srv/rbuilder/config/rbuilder.conf/"
Alias /jsonrpc/         "/srv/rbuilder/config/rbuilder.conf/"
Alias /                 "/srv/rbuilder/config/rbuilder.conf/"

<IfModule mod_deflate.c>
    SetOutputFilter DEFLATE

    # Don't compress images or swf (already compressed, won't cache without this)
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|swf|swz)$ no-gzip dont-vary

    # Make sure proxies don't deliver the wrong content
    Header append Vary User-Agent env=!dont-vary
</IfModule>

<Location />
    AddHandler python-program .conf
    PythonOption rbuilderConfig "/srv/rbuilder/config/rbuilder.conf"
    PythonOption basePath "/"
    PythonHandler mint.web.hooks
    SetEnv DJANGO_SETTINGS_MODULE mint.django_rest.settings
    PythonOption redirectIndex "1"
</Location>

# Django rest API
<Location "/api/reports">
    SetHandler python-program
    PythonHandler mint.django_rest.handler
    SetEnv DJANGO_SETTINGS_MODULE mint.django_rest.settings
    PythonDebug On
</Location>

<Location "/api/inventory">
    SetHandler python-program
    PythonHandler mint.django_rest.handler
    SetEnv DJANGO_SETTINGS_MODULE mint.django_rest.settings
    PythonDebug On
</Location>

<Location "/api/query_sets">
    SetHandler python-program
    PythonHandler mint.django_rest.handler
    SetEnv DJANGO_SETTINGS_MODULE mint.django_rest.settings
    PythonDebug On
</Location>

<Location /images/>
    # no need to compress images, they are all already compressed
    SetEnv no-gzip dont-vary
    SetHandler none
    AddType application/octet-stream .iso .img
</Location>
<Location /downloadImage>
    SetEnv no-gzip dont-vary
    SetHandler none
</Location>

<Location /favicon.ico>
    SetHandler none
</Location>

<Location /conary-static>
    SetHandler none
</Location>

<Location /conaryrc>
    SetHandler none
</Location>

<Location /xmlrpc/>
    AddHandler python-program .conf
    PythonHandler mint.web.rpchooks
</Location>

<Location /xmlrpc-private/>
    AddHandler python-program .conf
    PythonHandler mint.web.rpchooks
    PythonOption allowPrivate True

    # To restrict access to this rBuilder server's
    # "private" interfaces, uncomment the lines below.
    # For the command line client (/usr/bin/rbuilder)
    # to work, the client machine must have access to
    # /xmlrpc-private.

    # Order Deny,Allow
    # Deny From All
    # Allow From 127.0.0.1
    # Satisfy All

</Location>

<Location /jsonrpc/>
    AddHandler python-program .conf
    PythonHandler mint.web.rpchooks
</Location>

<Location /cgi-bin/>
    AddHandler cgi-script cgi
</Location>

<Directory /srv/www/cgi-bin/>
    Options +ExecCGI
</Directory>
