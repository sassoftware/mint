#!/usr/bin/python
#
# Copyright 2006 rPath, Inc.
# All Rights Reserved
#
from mint import config

import shutil
import sys
import os

def _doMigration(oldCfg, newCfg):
    allKeys = set(oldCfg.keys())
    generatedKeys = set(config.keysForGeneratedConfig)
    customKeys = allKeys - generatedKeys

    # save "generated" keys to rbuilder-generated.conf-stage
    generatedFile = open("/srv/rbuilder/config/rbuilder-generated.conf-stage", "w")
    for k in generatedKeys:
        oldCfg.displayKey(k, out = generatedFile)
    generatedFile.close()

    # everything else that is different from the stock config goes
    # in rbuilder-custom.conf-stage
    customFile = open("/srv/rbuilder/config/rbuilder-custom.conf-stage", "w+")
    for k in customKeys:
        if k == "visibleBuildTypes":
            continue
        if newCfg[k] != oldCfg[k]:
            oldCfg.displayKey(k, out = customFile)
    customFile.close()


if not os.path.exists("/srv/rbuilder/rbuilder.conf"):
    print "Old config file doesn't exist, skipping migration"
    sys.exit(1)

backupFile = "/srv/rbuilder/rbuilder.conf-pre-2.0.3"
shutil.copy("/srv/rbuilder/rbuilder.conf", backupFile)

oldCfg = config.MintConfig()
oldCfg.read("/srv/rbuilder/rbuilder.conf")

newCfg = config.MintConfig()
newCfg.read("/srv/rbuilder/config/rbuilder.conf")

if oldCfg.configured and not newCfg.configured:
    print "Migrating configuration files to new scheme..."
    _doMigration(oldCfg, newCfg)
    sys.exit(0)
else:
    print "No need to migrate configuration file at this time."
    sys.exit(1)

