#!/bin/bash
#
# Copyright (c) SAS Institute Inc.
#

# This script is executed from the group after each update. It migrates
# the mint database and all repository databases.
#
# NOTE: In the interests of avoiding cruft which no-one can explain 3
# years from now, all transitional migrations, workarounds, and anything
# that will not otherwise be self-explanatory in the future should be
# marked with a comment indicating when and for what version it was
# added as well as any relevant issue IDs.

scriptdir=$(dirname $0)

if [[ `awk '{print $2}' /proc/mounts | grep -c ^/proc$` > 1 ]]
then
    # If /proc appears to be mounted more than once, then it means we're
    # chrooted. It manifests itself this way as the actual path is
    # outside the chroot and thus can't be addressed.
    exit 0
fi

die() {
    echo "ERROR:" "$@"
    exit 1
}

# Pause nginx
[ -f /var/run/nginx.pid ] && kill -WINCH $(cat /var/run/nginx.pid)

# Stop all ancillary services
# crond is included so nothing fails during the migration (cf RBL-7973)
services="rmake3 rmake3-node rmake-messagebus rmake rmake-node mcp-dispatcher jobmaster rbuilder-authn rbuilder-credstore gunicorn crond"
reversed=$(echo "$services" | sed -e 's/ /\n/g' | tac)
for name in $reversed
do
    if [ -e /var/lock/subsys/$name ]
    then
        /sbin/service $name stop
    fi
done

"$scriptdir"/preconfigure || exit 1

service pgbouncer condstop
service pgbouncer start

chown -f apache:apache /srv/rbuilder/data/db /srv/rbuilder/repos/* 2>/dev/null
rm -f /srv/rbuilder/data/platformName.cache

# Migrate the mint config
"$scriptdir"/migrate-config --migrate || die "Failed to migrate the rBuilder configuration file"
chown apache:apache /srv/rbuilder/config/rbuilder-generated.conf

# Migrate all conary repositories
"$scriptdir"/migrate-all-projects

# Old pcreator sessions are no longer useful (or desirable)
rm -rf /srv/rbuilder/tmp/users

# raa-web user needs to be in apache group so that rbuilder-generated is readable by rapa
usermod -a -G apache raa-web

# Primary migration is done, exit maintenance mode now since some scripts need
# to talk to local repositories.
rm -f /srv/rbuilder/run/maintenance.lock

# Start ancillary services
for name in $services
do
    /sbin/service $name start
done

# Unpause nginx
service nginx reload

# Create initial platforms
echo Updating platforms ...
$scriptdir/create-platforms

echo Updating branch/stage information ...
$scriptdir/repository-sync


exit 0
