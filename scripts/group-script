#!/bin/sh
#
# Copyright (c) 2008 rPath, Inc.
# All rights reserved.
#
# This script is executed from the group after each update. It migrates
# the mint database and all repository databases.
#
# NOTE: In the interests of avoiding cruft which no-one can explain 3
# years from now, all transitional migrations, workarounds, and anything
# that will not otherwise be self-explanatory in the future should be
# marked with a comment indicating when and for what version it was
# added as well as any relevant issue IDs.

check_apache() {
    pidof httpd > /dev/null 2>&1
}

shutdown_apache() {
    if check_apache; then
        service httpd stop
        for i in $(seq 30); do
            if check_apache; then
                sleep 1
            else
                break
            fi
        done
        if check_apache; then
            echo "WARNING: httpd still running, killing httpd"
            killall httpd > /dev/null 2>&1
            if check_apache; then
                echo "WARNING: httpd *still* running, sending httpd signal 9"
                killall -9 httpd > /dev/null 2>&1
                if check_apache; then
                    echo "WARNING: failed to shutdown the Apache (httpd) service"
                fi
            fi
        fi
        START_APACHE=1
    else
        START_APACHE=0
    fi
}

die() {
    echo "ERROR:" "$@"
    exit 1
}

# Shut down apache, if it's running
shutdown_apache

# Migrate the mint database (or create it if it doesn't exist)
/usr/share/rbuilder/scripts/rbuilder-database --migrate \
    || die "Failed to migrate the rBuilder database"
chown apache:apache /srv/rbuilder/data/{db,platformName.cache}

# Migrate all conary repositories
/usr/share/rbuilder/scripts/migrate-all-projects || die "Failed to migrate all repositories"

# Migrate the mint config
/usr/share/rbuilder/scripts/migrate-config --migrate || die "Failed to migrate the rBuilder configuration file"
chown apache:apache /srv/rbuilder/config/rbuilder-generated.conf
# raa-web user needs to be in apache group so that rbuilder-generated is readable by rapa
usermod -a -G apache raa-web

# Create a project for rMake to use as a repository.
sudo -u apache /usr/share/rbuilder/scripts/rmake-setup

# Start apache again (if it was running before)
if [ $START_APACHE -eq 1 ]
then
    service httpd start
fi

### Extra Steps

# Re-add postgresql initscripts so that it picks up a new chkconfig.d entry
#   -- pre-4.1.0 - 2008-05-16
for initscript in postgresql postgresql-rbuilder
do
    if [ -f /etc/init.d/$initscript ]
    then
        /sbin/chkconfig --del $initscript
        /sbin/chkconfig --add $initscript
    fi
done

# Restart rMake
if [ -f /var/lock/subsys/rmake ]
then
    service rmake-node stop
    service rmake stop
    START_RMAKE=1
fi

if [[ -f /usr/sbin/gencert-rmake && ! -f /etc/rmake/ssl/ca.crt ]]
then
    # Generate rMake client CA and admin cert
    #   -- 5.0.0 - 2008-12-01

    # /dev is rather empty at image build time, but openssl needs entropy.
    [ -c /dev/urandom ] || /sbin/MAKEDEV -x urandom

    mkdir -p /etc/rmake/ssl
    /usr/sbin/gencert-rmake -a \
        -o /etc/rmake/ssl/ca.crt -O /etc/rmake/ssl/ca.key \
        -e 3653 --O='Auto-Generated' --OU='rMake Client CA'
    chmod 0644 /etc/rmake/ssl/ca.crt
    /usr/sbin/gencert-rmake -n \
        -c /etc/rmake/ssl/ca.crt -C /etc/rmake/ssl/ca.key \
        -o /etc/rmake/ssl/admin.pem -e 3653 -i /etc/rmake/ssl/index.txt \
        --O='Auto-Generated' --OU='rMake Admin Client' --site-user='admin'
fi

if [ "$START_RMAKE" == 1 ]
then
    service rmake start
    # TODO: Delete sleep workaround pending RMK-938
    #   -- 5.0.0 - 2008-12-01
    sleep 3
    service rmake-node start
fi
