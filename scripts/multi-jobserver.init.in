#!/bin/bash
#
# rbuilder-isogen:  Starts multiple rBuilder ISO generation servers.
#
# chkconfig: - 24 15
# description: This executes multiple job server daemons in separate chroots.
# processname: job-server
# config: @DESTDIR@/usr/bin

JOBSERVER_BASEPATH='/srv/rbuilder/jobserver'
SCRIPT_PATH='/usr/share/rbuilder/scripts'
JOBSERVER_SCRIPT="$SCRIPT_PATH/job-server"

# kill processes if necessary
case "$1" in
    stop|restart)
        killproc `basename $JOBSERVER_SCRIPT` -TERM
    ;;
esac

# do the rest of the operation
case "$1" in
    start|stop|restart|status)
        for js in `ls $JOBSERVER_BASEPATH`; do
            if [ -d "$JOBSERVER_BASEPATH/$js" ]; then
                if [ "$1" == "start" ] || [ "$1" == "restart" ]; then
                    cp /etc/hosts "$JOBSERVER_BASEPATH/$js/etc/hosts"
                    cp /etc/resolv.conf "$JOBSERVER_BASEPATH/$js/etc/resolv.conf"
                    cp /etc/nsswitch.conf "$JOBSERVER_BASEPATH/$js/etc/nsswitch.conf"
                elif [ "$1" == "status" ]; then
                    echo -n "Chrooted jobserver version $js: "
                fi
                /usr/sbin/chroot "$JOBSERVER_BASEPATH/$js" /etc/init.d/rbuilder-isogen $1
            fi
        done
    ;;
    *)
        echo "Usage: `basename $0` {start|stop|restart|status}"
    ;;
esac
